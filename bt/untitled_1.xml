<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="4"
      main_tree_to_execute="Untitled">
  <BehaviorTree ID="Object_task">
    <Sequence>
      <ManipulatorAction action_name="/goto_object_with_manipulator"
                         location="{object}"/>
      <ApplyPlanningScene objects="{object}"
                          operation="remove"
                          octomap=""/>
      <ChangeState service_name="/find_object_pose/change_state"
                   label="activate"/>
      <ForceSuccess>
        <Timeout msec="10000">
          <ManipulatorAction action_name="/single_object_task"
                             location="estop"/>
        </Timeout>
      </ForceSuccess>
      <ChangeState service_name="/find_object_pose/change_state"
                   label="deactivate"/>
      <ApplyPlanningScene objects="{object}"
                          operation="add"
                          octomap=""/>
      <Sleep msec="1000"/>
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="Untitled">
    <Sequence>
      <Sequence>
        <ChangeState service_name="/kinova/PointCloudXyzNode/change_state"
                     label="configure"/>
        <ChangeState service_name="/kinova/PointCloudXyzNode/change_state"
                     label="activate"/>
        <ChangeState service_name="/pose_finder/change_state"
                     label="configure"/>
        <ChangeState service_name="/pose_finder/change_state"
                     label="activate"/>
        <StandInFront location="target"/>
        <Repeat num_cycles="4">
          <Trigger service_name="/sit"/>
        </Repeat>
        <Sleep msec="1000"/>
        <RetryUntilSuccessful num_attempts="5">
          <ManipulatorAction action_name="/see_with_manipulator"
                             location=""/>
        </RetryUntilSuccessful>
        <ChangeState service_name="/pose_finder/change_state"
                     label="deactivate"/>
        <ChangeState service_name="/find_object_pose/change_state"
                     label="configure"/>
        <ChangeState service_name="/kinova/PointCloudXyzNode/change_state"
                     label="deactivate"/>
        <Sleep msec="1000"/>
        <ApplyPlanningScene objects="estop_M;estop_TL;estop_TR;estop_BL;estop_BR;"
                            operation="add"
                            octomap=""/>
        <ManipulatorAction action_name="clear_octomap_box"
                           location="estop_set"/>
        <ManipulatorAction action_name="clear_octomap_box"
                           location="rs_front_color_optical_frame"/>
        <GetOctomap service_name="/kinova/octomap_full"
                    octomap="{octomap}"/>
        <ApplyPlanningScene objects=""
                            operation="octomap"
                            octomap="{octomap}"/>
      </Sequence>
      <Fallback>
        <ForceFailure>
          <Sequence>
            <SetBlackboard value="estop_TL"
                           output_key="object"/>
            <SubTree ID="Object_task"
                     _autoremap="true"/>
          </Sequence>
        </ForceFailure>
        <ForceFailure>
          <Sequence>
            <SetBlackboard value="estop_TR"
                           output_key="object"/>
            <SubTree ID="Object_task"
                     _autoremap="true"/>
          </Sequence>
        </ForceFailure>
        <ForceFailure>
          <Sequence>
            <SetBlackboard value="estop_BL"
                           output_key="object"/>
            <SubTree ID="Object_task"
                     _autoremap="true"/>
          </Sequence>
        </ForceFailure>
        <ForceFailure>
          <Sequence>
            <SetBlackboard value="estop_BR"
                           output_key="object"/>
            <SubTree ID="Object_task"
                     _autoremap="true"/>
          </Sequence>
        </ForceFailure>
        <ForceFailure>
          <Sequence>
            <SetBlackboard value="estop_M"
                           output_key="object"/>
            <SubTree ID="Object_task"
                     _autoremap="true"/>
          </Sequence>
        </ForceFailure>
      </Fallback>
    </Sequence>
  </BehaviorTree>

  <!-- Description of Node Models (used by Groot) -->
  <TreeNodesModel>
    <Action ID="ApplyPlanningScene"
            editable="true">
      <input_port name="objects"/>
      <input_port name="operation"
                  default="add"/>
      <input_port name="octomap"/>
    </Action>
    <Action ID="ChangeState"
            editable="true">
      <input_port name="service_name"/>
      <input_port name="label"/>
    </Action>
    <Action ID="GetOctomap"
            editable="true">
      <input_port name="service_name"/>
      <output_port name="octomap"/>
    </Action>
    <Action ID="ManipulatorAction"
            editable="true">
      <input_port name="action_name">/see_with_manipulator, /goto_object_with_manipulator, /single_object_tast</input_port>
      <input_port name="location"/>
    </Action>
    <Action ID="StandInFront"
            editable="true">
      <input_port name="location"/>
    </Action>
    <Action ID="Trigger"
            editable="true">
      <input_port name="service_name"
                  default="/sit"/>
    </Action>
  </TreeNodesModel>

</root>
